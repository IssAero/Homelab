# ===============================
# Immich Helm Chart Values File
# ===============================
# -------------------------------
# Shared controllers configuration
# -------------------------------
controllers:
  main:
    containers:
      main:
        # Database, Redis, ML environment variables
        env:
          REDIS_HOSTNAME: immich-valkey.cloud.svc.cluster.local
          IMMICH_MACHINE_LEARNING_URL: http://immich-machine-learning:3003
          DB_HOSTNAME: immich-postgres-rw.cloud.svc.cluster.local
          DB_USERNAME:
            valueFrom:
              secretKeyRef:
                name: immich-postgres-user
                key: username
          DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: immich-postgres-user
                key: password
          DB_DATABASE_NAME:
            valueFrom:
              secretKeyRef:
                name: immich-postgres-user
                key: DB_DATABASE_NAME


# -------------------------------
# Immich core configuration
# -------------------------------
immich:
  metrics:
    enabled: false
  persistence:
    library:
      existingClaim: immich-library-pvc
  configuration: {}

# -------------------------------
# Valkey (Redis replacement)
# -------------------------------
valkey:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: docker.io/valkey/valkey
            tag: 9.0-alpine@sha256:73f3aa08d95879525aa0dc84ebf6b82b59b898a24e8067a37d6250c31ee2c4d4
            pullPolicy: IfNotPresent
  persistence:
    data:
      enabled: true
      size: 1Gi
      type: emptyDir
      accessMode: ReadWriteOnce

# -------------------------------
# Immich server component
# -------------------------------
server:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-server
            tag: v2.2.3
            pullPolicy: IfNotPresent
  ingress:
    main:
      enabled: false
      annotations:
        nginx.ingress.kubernetes.io/router.entrypoints: websecure
        nginx.ingress.kubernetes.io/service.serversscheme: https
        nginx.ingress.kubernetes.io/service.nativelb: "true"
        nginx.ingress.kubernetes.io/service.sticky.cookie: "true"
      hosts:
        - host: immich.kube
          paths:
            - path: "/"
      tls: []

# -------------------------------
# Immich machine-learning component
# -------------------------------
machine-learning:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-machine-learning
            pullPolicy: IfNotPresent
          env:
            TRANSFORMERS_CACHE: /cache
            HF_XET_CACHE: /cache/huggingface-xet
            MPLCONFIGDIR: /cache/matplotlib-config
  persistence:
    cache:
      enabled: true
      existingClaim: immich-ml-pvc
      size: 10Gi
      type: emptyDir
      accessMode: ReadWriteMany
